<metal:module-core
    define-macro="module_core"
    i18n:domain="collective.modules"
    tal:define="checkPermission python:context.restrictedTraverse('portal_membership').checkPermission;
                items python: context.items();
                image_helper nocall: context/@@image_helper;
                plone_view nocall: context/@@plone;
                link_url python:view.link_url(context.link);">

    <section class="teaser-flow stack-ml teaser-flow-posts push-ml module relation"
         tal:attributes="id python: 'module_' + context.getId()">

        <div tal:condition="python: context.title or context.description">
            <h3 class="strong sans-h6 a-center"
                tal:condition="python: context.title and context.display_title"
                tal:content="python: context.title">
                Title
            </h3>
            <h4 class="sans-h6 a-center"
                tal:condition="python: context.description"
                tal:content="python: context.description">
                Description
            </h4>
            <div class="module__text plain-txt"
               tal:condition="python: context.text"
               tal:content="structure python: context.text.output">
               Text
            </div>
        </div>

        <div class="stop">
            <ol class="flow-ml flickity-flow flickity-resized">
              <tal:item tal:repeat="item python: items">
                <li class="teaser-item teaser-item-event cell"
                    tal:define="images nocall:item/@@images;
                                tag python: images.tag(fieldname='image', width=261, height=348, alt=item.title, mode='contain');
                                is_event python: item.portal_type == 'Event';">
                    <a class="link-outer flow-m teaser-item-inner"
                       tal:attributes="href python: item.absolute_url();
                                       title python: item.title;">
                        <div class="item-illu d-block__s">
                                <img tal:replace="structure python: tag">
                        </div>

                        <div class="item-text">
                            <div class="item-text-inner stack-xs">
                                <tal:date tal:define="start python: getattr(item, 'start', False);
                                                      end python: getattr(item, 'end', False);"
                                          tal:condition="python: is_event and start">
                                    <div class="sans-h2b strong"
                                         tal:define="dates_for_display python: view.dates_for_display(item);">
                                        <tal:sameday tal:condition="python: dates_for_display['same_day']">
                                            <span class="nobr"
                                                  tal:content="python: start.strftime('%d.%m.')">01.06.</span>
                                        </tal:sameday>

                                        <tal:multiday tal:condition="python: not dates_for_display['same_day']">
                                            <span class="nobr">
                                              <span tal:replace="python: start.strftime('%d.%m.')" />
                                              <span>–</span>
                                            </span>
                                            <span tal:content="python: end.strftime('%d.%m.')" />
                                        </tal:multiday>
                                    </div>
                                </tal:date>
                                <div class="stack-xxs">
                                    <p class="mono-i1"
                                       tal:condition="python: is_event">
                                        <span tal:define="event_category python: getattr(item, 'event_category', [])"
                                              tal:condition="python: event_category"
                                              tal:content="python: ', '.join(event_category)" />
                                        <span tal:condition="python: getattr(item, 'location', False)"
                                              tal:content="python: ' · ' + item.location" />
                                    </p>
                                    <h4 class="sans-t2 strong"
                                        tal:content="python: item.title">
                                        Title
                                    </h4>
                                    <p class="sans-t2"
                                       tal:condition="python: not is_event"
                                       tal:content="python: plone_view.cropText(view.description(item), 130)">
                                        Description
                                    </p>
                                </div>
                                <p class="teaser-link sans-m2 strong">
                                    <span class="btn-link btn-s btn-icon-left trim">
                                        <span class="text"
                                              tal:content="python: context.link_text">Zum Termin
                                        </span>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </a>
                </li>
              </tal:item>
            </ol>
        </div>

        <div class="stack-s"
             tal:condition="python: link_url">
            <div class="a-center">
                <a class="btn-ghost btn"
                   tal:attributes="href python: link_url"
                   tal:content="python: context.link_button_text">
                    To Link
                </a>
            </div>
        </div>

        <div tal:condition="python: checkPermission('Modify portal content', context)">
            <a class="btn btn-primary btn-sm"
               tal:condition="python: checkPermission('Modify portal content', context)"
               tal:attributes="href python: context.absolute_url() + '/edit'">
                Edit Module
            </a>
        </div>

    </section>

</metal:module-core>
